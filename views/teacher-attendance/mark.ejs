<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark Teacher Attendance - School Management System</title>
  <link rel="stylesheet" href="/css/modern.css">
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container">
    <div class="page-header">
      <h2>Mark Teacher Attendance</h2>
      <a href="/teacher-attendance" class="btn btn-secondary">← Back</a>
    </div>

    <div class="card">
      <form method="POST" action="/teacher-attendance/mark" id="teacherAttendanceForm">
        <div class="form-group">
          <label>Date: *</label>
          <input type="date" name="date" id="date" class="form-control" value="<%= selectedDate %>" required>
          <div id="dateWarning" style="display: none; margin-top: 10px;"></div>
        </div>

        <h3 class="mb-3 mt-3">Teachers Attendance</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">Mark attendance for all teachers below:</p>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Teacher Name</th>
                <th>Subject</th>
                <th>Class & Section</th>
                <th>Status *</th>
                <th>Check-In</th>
                <th>Check-Out</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              <% teachers.forEach(teacher => { %>
                <tr>
                  <td><strong><%= teacher.name %></strong></td>
                  <td><%= teacher.subject ? teacher.subject.name : '-' %></td>
                  <td>
                    <%= teacher.class ? teacher.class.name : '-' %>
                    <%= teacher.section ? '(' + teacher.section + ')' : '' %>
                    <% if (teacher.isClassTeacher) { %>
                      <span style="background: #dbeafe; color: #3b82f6; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">Class Teacher</span>
                    <% } %>
                  </td>
                  <td>
                    <select name="attendanceData[<%= teacher._id %>][status]" class="form-control" style="min-width: 120px;">
                      <option value="">Not Marked</option>
                      <option value="Present">Present</option>
                      <option value="Absent">Absent</option>
                      <option value="Late">Late</option>
                      <option value="Half-Day">Half-Day</option>
                      <option value="Leave">Leave</option>
                    </select>
                  </td>
                  <td>
                    <input type="time" name="attendanceData[<%= teacher._id %>][checkIn]" class="form-control" style="min-width: 120px;">
                  </td>
                  <td>
                    <input type="time" name="attendanceData[<%= teacher._id %>][checkOut]" class="form-control" style="min-width: 120px;">
                  </td>
                  <td>
                    <input type="text" name="attendanceData[<%= teacher._id %>][notes]" class="form-control" placeholder="Optional notes" style="min-width: 150px;">
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <div class="flex gap-2 mt-3">
          <button type="submit" class="btn btn-primary" id="submitBtn">Submit Attendance</button>
          <a href="/teacher-attendance" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check if selected date is a working day
    document.getElementById('date').addEventListener('change', async function() {
      const selectedDate = this.value;
      const warningDiv = document.getElementById('dateWarning');
      const submitBtn = document.getElementById('submitBtn');
      
      try {
        const response = await fetch(`/holidays/check-working-day?date=${selectedDate}`);
        const data = await response.json();
        
        if (!data.isWorkingDay) {
          let message = '';
          if (data.type === 'sunday') {
            message = '⚠️ Warning: This is a Sunday (Weekly Off). Attendance cannot be marked.';
            warningDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
            warningDiv.style.borderLeft = '4px solid #ef4444';
          } else if (data.type === 'holiday') {
            message = `⚠️ Warning: This is a Holiday (${data.reason}). Attendance cannot be marked.`;
            if (data.description) {
              message += `<br><small>${data.description}</small>`;
            }
            warningDiv.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
            warningDiv.style.borderLeft = '4px solid #f59e0b';
          }
          
          warningDiv.innerHTML = message;
          warningDiv.style.display = 'block';
          warningDiv.style.padding = '12px';
          warningDiv.style.borderRadius = '6px';
          warningDiv.style.color = 'white';
          
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.5';
          submitBtn.style.cursor = 'not-allowed';
        } else {
          warningDiv.style.display = 'none';
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
        }
      } catch (error) {
        console.error('Error checking date:', error);
      }
    });
    
    // Trigger check on page load for default date
    window.addEventListener('load', function() {
      document.getElementById('date').dispatchEvent(new Event('change'));
    });
  </script>
  <script src="/js/main.js"></script>
</body>
</html>
